{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>CrushTrip 註冊</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 字型 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <!-- ICON 字型 -->
    <link rel="stylesheet" href="{% static 'fonts/material-design-iconic-font/css/material-design-iconic-font.min.css' %}">
    <!-- 自訂 CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; color: #333; }
        .alert {
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            position: relative;
        }
        .alert-success { background-color: #d4edda; color: #155724; }
        .alert-error { background-color: #f8d7da; color: #721c24; }
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        .alert .close {
            position: absolute; right: 10px; top: 5px;
            cursor: pointer; font-weight: bold;
            background: none; border: none; font-size: 1.2rem;
        }
        #avatarPreview {
            display: none;
            max-width: 120px;
            border-radius: 50%;
            margin: 10px auto;
        }
        #removeAvatarBtn {
            display: none;
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 0 auto 10px;
        }
        #passwordStrength {
            font-size: 0.85rem;
            margin-top: 5px;
        }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .step-btn { margin-top: 15px; }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            color: #333;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 0; /* 取消圓角 */
            box-sizing: border-box;
        }

        select:focus,
        input:focus {
            border-color: #5ab9ea;
            outline: none;
        }

        option {
            color: #333;
            background-color: #fff;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            max-height: 160px;
            overflow-y: auto;
        }

        .inner {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* 水平置中 */
            align-items: center;     /* 垂直置中 */
            min-height: 100vh;
        }

        .image-holder {
            flex: 1 1 300px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .image-holder img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        h3 {
            text-transform: none !important;
            
        }

        /* 左右並排按鈕樣式 */
        .step-btn-group {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 20px;
        }
        .step-btn-group .step-btn {
            flex: 1;
            text-align: center;
        }




    </style>
</head>

<body>
<div class="wrapper" style="background-image: url('{% static 'img/white.jpg' %}');">
    <div class="inner">
        <div class="image-holder">
            <img src="{% static 'img/registration-form-1.jpg' %}" alt="註冊圖片">
        </div>

        
        <form action="{% url 'register' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% if messages %}
                <div class="form-group">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                            <button type="button" class="close" onclick="this.parentElement.style.display='none';">&times;</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            
            <h3>CrushTrip 註冊</h3>

            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- 第一步 -->
            <div class="form-step step-1 active">
                <div class="form-wrapper">
                    <label for="{{ form.avatar.id_for_label }}">頭像上傳 (最大2MB)</label>
                    {{ form.avatar.errors }}
                    <img id="avatarPreview" alt="頭像預覽">
                    <button type="button" id="removeAvatarBtn">移除圖片</button>
                    <div id="avatarError"></div>
                    {{ form.avatar }}
                    <i class="zmdi zmdi-camera"></i>
                </div>

                <div class="form-group">
                    <div class="form-wrapper" style="width: 48%; float: left;">
                        <label for="{{ form.first_name.id_for_label }}">姓氏</label>
                        {{ form.first_name.errors }}
                        {{ form.first_name }}
                    </div>
                    <div class="form-wrapper" style="width: 48%; float: right;">
                        <label for="{{ form.last_name.id_for_label }}">名字</label>
                        {{ form.last_name.errors }}
                        {{ form.last_name }}
                    </div>
                    <div style="clear: both;"></div>
                </div>

                <div class="form-wrapper">
                    <label for="{{ form.username.id_for_label }}">帳號名稱</label>
                    {{ form.username.errors }}
                    {{ form.username }}
                    <i class="zmdi zmdi-account"></i>
                </div>

                <div class="form-wrapper">
                    <label for="{{ form.email.id_for_label }}">電子信箱</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        {% for error in form.email.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>


                <div class="form-wrapper">
                    <label for="{{ form.gender.id_for_label }}">性別</label>
                    {{ form.gender.errors }}
                    {{ form.gender }}
                    <i class="zmdi zmdi-caret-down"></i>
                </div>

                <button type="button" class="next-btn step-btn">下一步 <i class="zmdi zmdi-arrow-right"></i></button>
                <div class="form-wrapper" style="text-align: center; margin-top: 25px;">
                    <span style="font-size: 1.1rem;">已經有帳號了嗎？</span>
                    <a href="{% url 'login' %}" class="step-btn" 
                    style="font-size: 1.1rem; font-weight: bold; color: #3498db; margin-left: 8px;">
                    立即登入
                    </a>
                </div>
            </div>

            <!-- 第二步 -->
            <div class="form-step step-2">
                <div class="form-wrapper">
                    <label for="{{ form.travel_partner.id_for_label }}">期望旅伴性別</label>
                    {{ form.travel_partner.errors }}
                    {{ form.travel_partner }}
                    <i class="zmdi zmdi-male-female"></i>
                </div>

                <div class="form-wrapper">
                    <label for="{{ form.preferred_age_range.id_for_label }}">期望年齡層</label>
                    {{ form.preferred_age_range.errors }}
                    {{ form.preferred_age_range }}
                    <i class="zmdi zmdi-time"></i>
                </div>

                <div class="form-wrapper">
                    <label for="{{ form.preferred_travel.id_for_label }}">旅遊偏好 (最多 5 項)</label>
                    {{ form.preferred_travel.errors }}
                    <div class="checkbox-group">
                        {{ form.preferred_travel }}
                    </div>
                </div>

                <div class="form-wrapper">
                    <label for="{{ form.password1.id_for_label }}">密碼</label>
                    {{ form.password1 }}                    
                    {% if form.password1.errors %}
                        {% for error in form.password1.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                    <div id="passwordStrength"></div>
                </div>

                <div class="form-wrapper">
                    <label for="{{ form.password2.id_for_label }}">再次輸入密碼</label>
                    {{ form.password2 }}
                    {% if form.password2.errors %}
                        {% for error in form.password2.errors %}
                            <div class="alert alert-danger">{{ error }}</div>
                        {% endfor %}
                    {% endif %}
                </div>

                
                <div class="step-btn-group">
                    <button type="button" class="prev-btn step-btn">上一步<i class="zmdi zmdi-arrow-left"></i></button>
                    <button type="submit" class="step-btn">註冊 <i class="zmdi zmdi-check"></i></button>
                </div>

                


            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script src="{% static 'js/vendor/jquery-2.2.4.min.js' %}"></script>
<script src="{% static 'js/main.js' %}"></script>
<script>
    document.querySelector('.next-btn').addEventListener('click', () => {
    const requiredFields = [
        { field: document.getElementById("id_avatar"), name: "頭像上傳" },
        { field: document.getElementById("id_first_name"), name: "姓氏" },
        { field: document.getElementById("id_last_name"), name: "名字" },
        { field: document.getElementById("id_username"), name: "帳號名稱" },
        { field: document.getElementById("id_email"), name: "電子信箱" },
        { field: document.getElementById("id_gender"), name: "性別" }
    ];

    let hasError = false;

    // 清除舊錯誤
    document.querySelectorAll('.alert-danger').forEach(e => e.remove());

    requiredFields.forEach(item => {
        const field = item.field;
        const value = field.value.trim();

        if (!value) {
            hasError = true;
            const error = document.createElement("div");
            error.classList.add("alert", "alert-danger");
            error.textContent = `${item.name}為必填欄位`;
            field.parentNode.appendChild(error);
        }

        // 額外驗證 email 格式
        if (field.id === "id_email" && value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                hasError = true;
                const error = document.createElement("div");
                error.classList.add("alert", "alert-danger");
                error.textContent = "請輸入正確的電子信箱格式";
                field.parentNode.appendChild(error);
            }
        }
    });

    if (!hasError) {
        document.querySelector('.step-1').classList.remove('active');
        document.querySelector('.step-2').classList.add('active');
    }
});

    document.querySelector('.prev-btn').addEventListener('click', () => {
        document.querySelector('.step-2').classList.remove('active');
        document.querySelector('.step-1').classList.add('active');
    });

    
    const avatarInput = document.getElementById("id_avatar");
    const avatarPreview = document.getElementById("avatarPreview");
    const removeBtn = document.getElementById("removeAvatarBtn");
    const errorMsg = document.getElementById("avatarError");

    avatarInput.addEventListener("change", function () {
        const file = this.files[0];
        errorMsg.textContent = "";
        avatarPreview.style.display = "none";
        removeBtn.style.display = "none";

        if (file) {
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                errorMsg.textContent = "只允許上傳 JPG 或 PNG 格式的圖片。";
                avatarInput.value = "";
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                errorMsg.textContent = "檔案太大，請選擇小於 2MB 的圖片。";
                avatarInput.value = "";
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                avatarPreview.src = e.target.result;
                avatarPreview.style.display = "block";
                removeBtn.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
    });

    removeBtn.addEventListener("click", function () {
        avatarInput.value = "";
        avatarPreview.src = "";
        avatarPreview.style.display = "none";
        removeBtn.style.display = "none";
        errorMsg.textContent = "";
    });

    document.getElementById("id_password1").addEventListener("input", function () {
        const strength = document.getElementById("passwordStrength");
        const value = this.value;
        let score = 0;
        if (value.length >= 8) score++;
        if (/[A-Z]/.test(value)) score++;
        if (/\d/.test(value)) score++;
        if (/[^A-Za-z0-9]/.test(value)) score++;

        const levels = ["非常弱", "弱", "中等", "強", "非常強"];
        strength.textContent = "密碼強度：" + levels[score];
        strength.style.color = ["red", "orangered", "orange", "green", "darkgreen"][score];
    });

    // 限制 checkbox 最多選 5 項
    const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            const checked = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
            if (checked.length > 5) {
                cb.checked = false;
                alert("最多只能選擇 5 項旅遊偏好！");
            }
        });
    });

    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 800);
        });
    }, 6000);

    // 根據伺服器傳來的 step 顯示頁面
    const stepFromServer = {{ step|default:1 }};
    if (stepFromServer === 2) {
        document.querySelector('.step-1').classList.remove('active');
        document.querySelector('.step-2').classList.add('active');
    } else {
        document.querySelector('.step-1').classList.add('active');
        document.querySelector('.step-2').classList.remove('active');
    }

</script>

</body>
</html>

