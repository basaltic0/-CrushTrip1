<!DOCTYPE html>
{% load static %}
<html lang="zh-hant" class="no-js">
<head>
    
    {% comment %} <link rel="stylesheet" href="{% static 'css/style.css' %}"> {% endcomment %}
    <script src="{% static 'js/main.js' %}"></script>
    {% comment %} <img src="{% static 'img/logo.png' %}" alt="Logo"> {% endcomment %}
    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicon-->
    <link rel="shortcut icon" href="{% static 'favicon.png' %}">
    <!-- Author Meta -->
    <meta name="author" content="colorlib">
    <!-- Meta Description -->
    <meta name="description" content="">
    <!-- Meta Keyword -->
    <meta name="keywords" content="">
    <!-- meta character set -->
    <meta charset="UTF-8">
    <!-- Site Title -->
    <title>CrushTrip 購物車</title>

    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,400,300,500,600,700" rel="stylesheet">
    <!--
    CSS
    ============================================= -->
    <link rel="stylesheet" href="{% static 'css/linearicons.css' %}">
    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/magnific-popup.css' %}">
    {% comment %} <link rel="stylesheet" href="{% static 'css/animate.min.css' %}"> {% endcomment %}
    <link rel="stylesheet" href="{% static 'css/owl.carousel.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}" />
    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}" />
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700" rel="stylesheet" />
    <style>
    .contact-form .row {
      align-items: stretch;
    }

    .contact-form .col-md-6 {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .contact-form textarea {
      height: 100%;
      resize: none;
    }

    .alert {
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            position: relative;
            }
    .alert-success { background-color: #d4edda; color: #155724; }
    .alert-error { background-color: #f8d7da; color: #721c24; }
    .alert-danger {
          word-break: break-word;
          white-space: normal;
          overflow: visible;
          display: block;
          margin-top: 5px;S
          }
    .alert .close {
        position: absolute; right: 10px; top: 5px;
        cursor: pointer; font-weight: bold;
        background: none; border: none; font-size: 1.2rem;
    }        
    input[type="text"],
    input[type="email"],
    select {
        width: 100%;
        padding: 10px;
        font-size: 1rem;
        color: #333;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 0; /* 取消圓角 */
        box-sizing: border-box;
    }

    select:focus,
    input:focus {
        border-color: #5ab9ea;
        outline: none;
    }

    option {
        color: #333;
        background-color: #fff;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
        max-height: 160px;
        overflow-y: auto;
    }

    .inner {
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* 水平置中 */
        align-items: center;     /* 垂直置中 */
        min-height: 100vh;
    }

    body {
  font-family: 'Noto Sans TC', 'Poppins', sans-serif;
  background-color: #f8f9fa;
}

.profile-update-section {
  padding: 60px 20px 80px;
  background: #ffffff;
}

.form-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 40px;
  background-color: #fff;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
  border-radius: 12px;
}

.form-container h2 {
  text-align: center;
  margin-bottom: 30px;
  font-weight: 600;
  color: #333;
}

.form-wrapper {
  margin-bottom: 20px;
}

label {
  font-weight: 600;
  color: #333;
}

.step-btn {
  display: block;
  width: 100%;
  background-color: #5ab9ea;
  color: white;
  padding: 12px 0;
  border: none;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 6px;
  margin-top: 25px;
  transition: background-color 0.3s ease;
}

.step-btn:hover {
  background-color: #3ca7d3;
}

#formStatus {
  margin-top: 30px;
  text-align: center;
}
.default-header {
  background-color: #212529 !important;  /* Bootstrap bg-dark 顏色 */
}

input.is-invalid {
  border-color: #dc3545;
  background-color: #fff0f0;
}
.contact-form .row {
      align-items: stretch;
    }

    .contact-form .col-md-6 {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .contact-form textarea {
      height: 100%;
      resize: none;
    }

    .alert {
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            position: relative;
            }
    .alert-success { background-color: #d4edda; color: #155724; }
    .alert-error { background-color: #f8d7da; color: #721c24; }
    .alert-danger {
          word-break: break-word;
          white-space: normal;
          overflow: visible;
          display: block;
          margin-top: 5px;S
          }
    .alert .close {
        position: absolute; right: 10px; top: 5px;
        cursor: pointer; font-weight: bold;
        background: none; border: none; font-size: 1.2rem;
    }        
    input[type="text"],
    input[type="email"],
    select {
        width: 100%;
        padding: 10px;
        font-size: 1rem;
        color: #333;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 0; /* 取消圓角 */
        box-sizing: border-box;
    }

    select:focus,
    input:focus {
        border-color: #5ab9ea;
        outline: none;
    }

    option {
        color: #333;
        background-color: #fff;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
        max-height: 160px;
        overflow-y: auto;
    }

    .inner {
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* 水平置中 */
        align-items: center;     /* 垂直置中 */
        min-height: 100vh;
    }

    body {
  font-family: 'Noto Sans TC', 'Poppins', sans-serif;
  background-color: #f8f9fa;
}

.profile-update-section {
  padding: 60px 20px 80px;
  background: #ffffff;
}

.form-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 40px;
  background-color: #fff;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
  border-radius: 12px;
}

.form-container h2 {
  text-align: center;
  margin-bottom: 30px;
  font-weight: 600;
  color: #333;
}

.form-wrapper {
  margin-bottom: 20px;
}

label {
  font-weight: 600;
  color: #333;
}

.step-btn {
  display: block;
  width: 100%;
  background-color: #5ab9ea;
  color: white;
  padding: 12px 0;
  border: none;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 6px;
  margin-top: 25px;
  transition: background-color 0.3s ease;
}

.step-btn:hover {
  background-color: #3ca7d3;
}

#formStatus {
  margin-top: 30px;
  text-align: center;
}
.default-header {
  background-color: #212529 !important;  /* Bootstrap bg-dark 顏色 */
}

input.is-invalid {
  border-color: #dc3545;
  background-color: #fff0f0;
}

body {
  font-family: "Poppins", sans-serif;
  background: #f9f9f9;
}
/* 旅遊設定區 */
#travelSettings {
  background: #fff;
  padding: 30px 20px ;
  padding-top: 100px;
  margin: 30px auto;
  max-width: 960px;
  border-radius: 8px;
  box-shadow: 0 0 12px rgba(0,0,0,0.1);
}

#travelSettings h2 {
  margin-bottom: 20px;
  font-weight: 700;
  text-align: center;
}
.form-group {
  margin-bottom: 1rem;
}
label {
  font-weight: 600;
}
.radio-group {
  display: flex;
  gap: 20px;
  margin-bottom: 15px;
}
.radio-group label {
  font-weight: normal;
}
#preferenceSection {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}
#startTripBtn {
  display: block;
  width: 100%;
  max-width: 200px;
  margin: 0 auto;
  background-color: #007bff;
  border: none;
  color: white;
  padding: 12px 0;
  font-size: 18px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#startTripBtn:hover {
  background-color: #0056b3;
}
/* 購物車列表 */
#cartSection {
  max-width: 960px;
  margin: 30px auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 12px rgba(0,0,0,0.1);
}
#cartSection h3 {
  margin-bottom: 15px;
  font-weight: 700;
}
.cart-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}
.cart-item:last-child {
  border-bottom: none;
}
.cart-item-name {
  font-size: 16px;
}
.cart-item-remove {
  cursor: pointer;
  color: #dc3545;
  font-size: 20px;
  transition: color 0.3s ease;
}
.cart-item-remove:hover {
  color: #a71d2a;
}
/* 行程產出區 */
#itinerarySection {
  max-width: 960px;
  margin: 30px auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 12px rgba(0,0,0,0.1);
  display: none;
}
#itinerarySection h3 {
  margin-bottom: 15px;
  font-weight: 700;
}
#itineraryContent {
  white-space: pre-wrap;
  font-size: 16px;
  line-height: 1.5;
  margin-bottom: 20px;
}
#bookingLinks {
  text-align: right;
}
#bookingLinks a {
  display: inline-block;
  background-color: #007bff;
  color: white;
  padding: 10px 15px;
  margin-left: 10px;
  border-radius: 6px;
  text-decoration: none;
  transition: background-color 0.3s ease;
}
#bookingLinks a:hover {
  background-color: #0056b3;
}
/* 行程調整對話框 */
#adjustmentSection {
  max-width: 960px;
  margin: 30px auto 60px;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 12px rgba(0,0,0,0.1);
}
#adjustmentSection h3 {
  margin-bottom: 15px;
  font-weight: 700;
}
#adjustmentInput {
  width: 100%;
  height: 100px;
  padding: 10px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: vertical;
  margin-bottom: 15px;
}
#adjustmentButtons {
  display: flex;
  justify-content: flex-end;
  gap: 15px;
}
#adjustBtn {
  background-color: #007bff;
  color: white;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#adjustBtn:hover {
  background-color: #0056b3;
}
#packageBtn {
  background-color: #28a745;
  color: white;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
#packageBtn:hover {
  background-color: #1e7e34;
}
.footer-area {
  padding-top: 100px;
  background-color: #222222;
}

h6 {
  color: #fff;
  margin-bottom: 25px;
  font-size: 18px;
  font-weight: 600;
}

.footer-area p {
  color: #777777;
  font-weight: 300;
  font-size: 14px;
}
.dropdown-item {
  font-size: 14px;
  width: auto !important;
  text-align: left;
}

@media (max-width: 767px) {
  .dropdown-item {
    text-align: left;
    padding: 0.25rem;
  }
}

@media (min-width: 768px) {
  .dropdown .dropdown-menu {
    display: block;
    opacity: 0;
    -webkit-transition: all 200ms ease-in;
    -moz-transition: all 200ms ease-in;
    -ms-transition: all 200ms ease-in;
    -o-transition: all 200ms ease-in;
    transition: all 200ms ease-in;
  }
  .dropdown:hover .dropdown-menu {
    display: block;
    opacity: 1;
  }
}

.dropdown-menu {
  background: #222;
  border-radius: 0;
  margin-top: 15px;
  border: none;
}

.dropdown-menu a {
  padding: 5px 15px;
}

@media (max-width: 767px) {
  .dropdown-menu {
    margin-top: 0px;
  }
}

.dropdown-item:focus, .dropdown-item:hover {
  color: #fff;
  text-decoration: none;
  background-color: transparent;
}

/* 只針對第一層 navbar 連結加大 padding 和白字 */
.navbar-nav > li > a {
  text-transform: uppercase;
  font-weight: 600;
  color: #fff;
  padding:  20px;
  font-size: 16px;
}

@media (max-width: 992px) {
  .navbar-nav > li > a {
    padding: 15px 10px;
    color: #fff; /* 強制字白色 */
  }
  .dropdown-menu a {
    padding: 8px 20px;
    color: #212529;
  }
  .navbar-nav li {
    padding: 15px 0;
  }
}
.navbar {
  min-height: 20px !important;  /* 缩小最小高度，改成适合你的值 */
  padding-top: 0 !important;  
  padding-bottom: 0 !important;
}
.navbar-nav a,
.navbar-nav a:hover,
.navbar-nav a:focus,
.navbar-nav a:active,
.navbar-nav a:visited {
  text-decoration: none !important;  
  outline: none;                    
}

.form-group.row {
  display: flex;
  gap: 16px; /* 欄位間距 */
}

.form-group.row > div {
  flex: 1;
  display: flex;
  flex-direction: column;
}

    </style>
</head>
<body>   
       <!-- start banner Area -->
    <section class="banner-area" id="home">
        <!-- Start Header Area -->
        <header class="default-header">
            <nav class="navbar navbar-expand-lg  navbar-light fixed-top" 
                style="background-color: #001f3f;">
                <div class="container">
                      <a class="navbar-brand" href="{% url 'index' %}">
                        <img src="{% static 'img/logo.png' %}" alt="CrushTrip Logo" style="height:80px;">
                      </a>
                      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="text-white lnr lnr-menu"></span>
                      </button>

                    <div class="collapse navbar-collapse justify-content-end align-items-center" id="navbarSupportedContent">
                        <ul class="navbar-nav">
                            <li><a href="{% url 'index' %}#about">關於我們</a></li>
                            <li><a href="{% url 'spots' %}">客製行程</a></li>
                            <li><a href="{% url 'index' %}#spot">熱門景點</a></li>
                            {% comment %} <li><a href="{% url 'index' %}#mate">尋找旅伴</a></li> {% endcomment %}
                            <li><a href="{% url 'index' %}#faq">常見問題</a></li>
                            <li><a href="{% url 'index' %}#contact">聯絡我們</a></li>
                            <!-- Dropdown -->
                            
                            <li class="dropdown">
                                <a class="dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown">
                                會員中心
                                </a>
                                <div class="dropdown-menu">
                                <a class="dropdown-item" href="{% url 'update_profile' %}">修改會員資料</a>                  
                                <a class="dropdown-item" href="{% url 'logout' %}">登出</a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <!-- End Header Area -->
        <!-- 旅遊設定區 -->
    
    <section id="travelSettings" aria-label="旅遊設定區">
      <h2>旅遊設定</h2>
      <form id="travelForm" class="needs-validation" novalidate>         
        <div class="form-group row">
          <div class="col-6">
            <label for="departureDate">去程日期</label>
            <input type="date" id="departureDate" name="departureDate" class="form-control" required />
          </div>
          <div class="col-6">
            <label for="returnDate">回程日期</label>
            <input type="date" id="returnDate" name="returnDate" class="form-control" required />
          </div>
        </div>
        <div class="form-group row" style="margin-top: 15px;">
          <div class="col-3">
            <label for="departurePrefecture">去程縣市</label>
            <select id="departurePrefecture" name="departurePrefecture" class="form-control" required>
              <option value="" disabled selected>請選擇去程縣市</option>    
             <optgroup label="北海道">
                <option value="sapporo">札幌與周邊地區</option>
                <option value="hakodate">函館與北海道南部</option>
              </optgroup>
              <optgroup label="關東">
                <option value="tokyo">東京</option>
                <option value="yokohama">橫濱</option>
                <option value="saitama">埼玉新都心</option>
                <option value="chiba">千葉</option>
              </optgroup>
              <optgroup label="東海">
                <option value="nagoya">名古屋市中心</option>
                <option value="fuji">富士山(山梨)</option>
              </optgroup>
              <optgroup label="關西">
                <option value="osaka">大阪灣地區</option>
                <option value="kyoto">京都車站周邊區域</option>
                <option value="nara">奈良市</option>
                <option value="kobe">神戶</option>
              </optgroup>
              <optgroup label="九州">
                <option value="fukuoka">福岡市</option>
                <option value="kumamoto">熊本市</option>
                <option value="kagoshima">鹿兒島市</option>
                <option value="nagasaki">長崎市</option>
                <option value="miyazaki">宮崎市</option>
              </optgroup>
              <optgroup label="沖繩">
                <option value="naha">那霸</option>
                <option value="ishigaki">石垣島</option>
                <option value="miyako">宮古島</option>
              </optgroup>
          </select>
        </div>
        <div class="col-3">
          <label for="returnPrefecture">回程縣市</label>
          <select id="returnPrefecture" name="returnPrefecture" class="form-control" required>
            <option value="" disabled selected>請選擇回程縣市</option>
              <optgroup label="北海道">
                <option value="sapporo">札幌與周邊地區</option>
                <option value="hakodate">函館與北海道南部</option>
              </optgroup>
              <optgroup label="關東">
                <option value="tokyo">東京</option>
                <option value="yokohama">橫濱</option>
                <option value="saitama">埼玉新都心</option>
                <option value="chiba">千葉</option>
              </optgroup>
              <optgroup label="東海">
                <option value="nagoya">名古屋市中心</option>
                <option value="fuji">富士山(山梨)</option>
              </optgroup>
              <optgroup label="關西">
                <option value="osaka">大阪灣地區</option>
                <option value="kyoto">京都車站周邊區域</option>
                <option value="nara">奈良市</option>
                <option value="kobe">神戶</option>
              </optgroup>
              <optgroup label="九州">
                <option value="fukuoka">福岡市</option>
                <option value="kumamoto">熊本市</option>
                <option value="kagoshima">鹿兒島市</option>
                <option value="nagasaki">長崎市</option>
                <option value="miyazaki">宮崎市</option>
              </optgroup>
              <optgroup label="沖繩">
                <option value="naha">那霸</option>
                <option value="ishigaki">石垣島</option>
                <option value="miyako">宮古島</option>
              </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label for="travelers">旅遊人數</label>
          <select id="travelers" name="travelers" class="form-control" required>
            <option value="" disabled selected>請選擇人數</option>
            <option value="1">1 人</option>
            <option value="2">2 人</option>
            <option value="3">3 人</option>
            <option value="4">4 人</option>
            <option value="5">5 人</option>
            <option value="6">6 人</option>
          </select>
        </div>
    
        <div class="form-group">
          <label for="style">行程風格</label>
          <select id="style" name="style" class="form-control" style="max-width: 200px;" required>
            <option value="" disabled selected>請選擇行程風格</option>
            <option value="compact">緊湊</option>
            <option value="moderate">適中</option>
            <option value="leisure">休閒</option>
          </select>
        </div>
      </form>
    </section>
    
    <!-- 購物車區 -->
    <section id="cartSection" aria-label="購物車區">
      <h3>已加入的景點</h3>
      <div id="cartList"></div><button id="startTripBtn" style="margin-top:15px; display:block; max-width: 200px;">出發</button>
      <div id="statusMessage" style="display: none; color: #007bff; margin-top: 10px; text-align: center;"></div>
      {% comment %} <div id="statusMessage" style="color: #007bff; margin-top: 10px; text-align: center;">AAA</div> {% endcomment %}
    </section>

    <input type="hidden" id="id_email" value="{{ request.user.email }}">

    <!-- 搜尋出發/查詢按鈕 -->
      <div id="itinerarySection" style="display:none;">
        <div id="itineraryContent"></div>
          <div id="bookingLinks">
            <a href="https://www.booking.com/"target="_blank">訂房</a>
          </div>
          <div id="bookingLinks">
            <a href="https://www.skyscanner.com.tw/"target="_blank">訂票</a>
          </div>
        </div>

    <!-- 行程產出區 -->
    <section id="itinerarySection" aria-label="行程產出區" style="display:none;">
      <h3>生成的行程</h3>
      <pre id="itineraryContent" style="background:#f0f0f0; padding:15px; border-radius:6px; min-height:200px;">請點擊「出發」生成行程</pre>
      <div id="bookingLinks"></div>
    </section>
    
    <!-- 行程調整對話框 -->
    <section id="adjustmentSection" aria-label="行程調整" style="max-width:960px; margin:30px auto 60px; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 12px rgba(0,0,0,0.1);">
      <h3>行程調整</h3>
      <textarea id="adjustmentInput" placeholder="請輸入調整需求..." style="width:100%; height:100px; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:6px; resize:vertical; margin-bottom:15px;"></textarea>
      <div style="display:flex; justify-content:flex-end; gap:15px;">
        <button id="adjustBtn" style="background:#007bff; color:#fff; padding:10px 20px; font-size:16px; border-radius:6px; border:none; cursor:pointer;">送出調整需求</button>
        <button id="packageBtn" style="background:#28a745; color:#fff; padding:10px 20px; font-size:16px; border-radius:6px; border:none; cursor:pointer;">生成PDF並寄送</button>
      </div>
    </section>

    <!-- start footer Area -->
    <footer class="footer-area section-gap">
        <div class="container">
            <div class="row">
                <div class="col-lg-5 col-md-6 col-sm-6">
                    <div class="single-footer-widget">
                        <h6>重新定義旅遊的方式</h6>
                        <p>我們相信旅程不只是抵達目的地，而是在途中遇見共鳴的靈魂、激發新的視野。透過個人化的旅伴推薦機制與深入的偏好設定，CrushTrip 讓每一次的出發都蘊含探索與連結的可能。我們致力打造一個兼具效率與情感溫度的旅遊體驗，讓每個使用者都能在旅程中找到與自己節奏契合的夥伴與回憶。加入我們，開啟屬於你的 CrushTrip 冒險。                        </p>
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                        <p class="footer-text">Crushtrip &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="fa fa-heart-o" aria-hidden="true"></i>Crushtrip</p>
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    </div>
                </div>
                <div class="col-lg-5  col-md-6 col-sm-6">
                    <div class="single-footer-widget">
                        <h6>Newsletter</h6>
                        <p>Stay update with our latest</p>
                        
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <!-- End footer Area -->   
        
    <script src="{% static 'js/vendor/jquery-2.2.4.min.js' %}"></script>
    <!-- Magnific Popup CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.css">
    <!-- Magnific Popup JS -->
    <script src="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="{% static 'js/vendor/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/jquery.sticky.js' %}"></script>
    <script src="{% static 'js/jquery.counterup.min.js' %}"></script>
    <script src="{% static 'js/waypoints.min.js' %}"></script>
    <script src="{% static 'js/plugin.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/jquery.ajaxchimp/1.3.0/jquery.ajaxchimp.min.js"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
    
      
      // 日期選擇器限制：不可選過去，最多兩年內
      document.addEventListener('DOMContentLoaded', () => {
        const departureDate = document.getElementById('departureDate');
        const returnDate = document.getElementById('returnDate');

        const today = new Date();
        const maxDate = new Date();
        maxDate.setFullYear(maxDate.getFullYear() + 2);

        const formatDate = (date) => date.toISOString().slice(0, 10);

        departureDate.min = formatDate(today);
        departureDate.max = formatDate(maxDate);

        returnDate.min = formatDate(today);
        returnDate.max = formatDate(maxDate);
      });

    
      // 預設購物車 5 個景點資料
      {% comment %} let shoppingCart = [
        { id: 1, name: "札幌時計台"}, //thumbnail: "{% static 'img/sapporo_clock_tower.jpg' %}" },
        { id: 2, name: "東京塔"}, //thumbnail: "{% static 'img/tokyo_tower.jpg' %}" },
        { id: 3, name: "淺草寺"}, //thumbnail: "{% static 'img/sensoji.jpg' %}" },
        { id: 4, name: "大阪城"}, //thumbnail: "{% static 'img/osaka_castle.jpg' %}" },
        { id: 5, name: "福岡塔"}, //thumbnail: "{% static 'img/fukuoka_tower.jpg' %}" }

      ]; {% endcomment %}

      fetch('/cart/api/', {
        headers: {'Accept': 'application/json'},
        credentials: 'include', // 確保帶 cookie 以驗證登入
      })
      .then(response => {
        if (!response.headers.get('content-type').includes('application/json')) {
          throw new Error('非 JSON 回傳，可能是未登入或 API 錯誤。');
        }
        return response.json();
        })
      .then(data => {
        shoppingCart = data.shoppingCart || [];
        console.log('從 API 拿到購物車資料:', shoppingCart);
        renderCart(shoppingCart);
      })
      .catch(err => {
        console.error('購物車載入失敗:', err.message);
      });
    
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // 渲染購物車列表
      function renderCart(cartItems) {
        const cartList = document.getElementById('cartList');
        //console.log('renderCart called, shoppingCart:', shoppingCart);
        //console.log('cartList:', cartList);
        //console.log('shoppingCart length:', shoppingCart.length);
        cartList.innerHTML = '';

        if (!shoppingCart || shoppingCart.length === 0) {
          cartList.innerHTML = '<p>購物車目前是空的。</p>';
          return;
        }

        shoppingCart.forEach(item => {
          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
              <img src="${item.thumbnail}" alt="${ item.name }" style="width:60px; height:40px; object-fit:cover; border-radius:4px;">
              <span class="cart-item-name">${item.parent_title}</span>
            </div>
            <i class="fa fa-trash cart-item-remove" title="移除景點" style="cursor:pointer;"></i>

            `;
          const removeBtn = div.querySelector('.cart-item-remove');
          removeBtn.addEventListener('click', () => {
            fetch('/myapp/cart/remove/', {
              method: 'POST',  // 或 'DELETE'（視後端定義）
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),  // CSRF Token 必須
              },
              credentials: 'include',  // 帶上 cookie 以驗證登入
              body: JSON.stringify({ id: item.id }),
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // 後端刪除成功，再從前端資料中移除並重新渲染
                shoppingCart = shoppingCart.filter(i => i.id !== item.id);
                renderCart(shoppingCart);
              } else {
                alert('刪除失敗：' + data.message);
              }
            })
            .catch(() => alert('刪除失敗，請稍後再試'));
            
          });
          cartList.appendChild(div);
        });
      }
      //抓取旅遊偏好
      function getUserPreferences() {
          return Array.from(document.querySelectorAll('input[name="preferred_travel"]:checked'))
              .map(cb => cb.value);
      }

      function getCartData() {
        return JSON.parse(localStorage.getItem('shoppingCart')) || [];
      }

    
      // 初始化
      document.addEventListener('DOMContentLoaded', () => {
        loadShoppingCart();
      });

      document.getElementById('startTripBtn').addEventListener('click', async () => {
      const statusEl = document.getElementById('statusMessage');
      statusEl.innerText = '行程生成中...';
      statusEl.style.display = 'block';

      // 取得表單資料（新的 id 名稱）
      const departureDate = document.getElementById('departureDate').value;
      const returnDate = document.getElementById('returnDate').value;
      const departurePrefecture = document.getElementById('departurePrefecture').value;
      const returnPrefecture = document.getElementById('returnPrefecture').value;
      const travelers = document.getElementById('travelers').value;  
      const style = document.getElementById('style').value;  
      const styleMap = {compact: '緊湊', moderate: '適中', leisure: '休閒'};
      const styleName = styleMap[style] || style;    
      // 必填驗證 && 邏輯驗證
      if (!departureDate || !returnDate || !departurePrefecture || !returnPrefecture || !travelers || !style) {
          alert('請填寫完整行程設定');
          return;
      }
      if (returnDate < departureDate) {
        alert('回程日期不得早於去程日期');
        return;
      }

      // 1. 取得使用者旅遊偏好
      const userPref = getUserPreferences();

      // 2. 取得購物車景點名稱
      const attractions = shoppingCart.map(item => item.name);

      // 3. 組成 GPT 提示詞
      const prompt = `
      請根據以下資訊幫我產出一個完整的日本旅遊行程建議：
    - 出發日期：${departureDate}
    - 回程日期：${returnDate}
    - 去程縣市：${departurePrefecture}
    - 回程縣市：${returnPrefecture}
    - 旅遊人數：${travelers} 人
    - 行程風格：${styleName}
    - 使用者旅遊偏好：${userPref.length > 0 ? userPref.join(', ') : '無'}
    - 已選擇景點：${attractions.join(', ')}

    請包含以下內容：
    1. 行程總覽(詳細版包括時間點、航班資訊)
    2. 可能的天氣概況
    3. 景點安排(詳細的推估時間)
    4. 轉乘交通資訊與推薦(一併放在行程總覽內)
    5. 推薦用餐地點與費用估算(一併附上相關超連結)
    6. 每日推薦住宿與來回機票訂購網站超連結
    7. 預估整趟行程費用

    請滿足：
    1. 已選購物車內所有景點都需安排、優先安排出發/回程地相關景點。
    2. 若行程天數多於購物車景點數，請依偏好及出發/回程地區，自動推薦適合景點填滿。
    3. 如果購物車中的景點為空，或景點數不足以覆蓋全部天數，請依使用者偏好與旅遊區域，自動推薦補足行程。
    4. 旅遊地點要有多樣化，交通動線要流暢。
    5. 景點名稱、每日行程、交通建議、餐飲住宿推薦皆要詳細。
    `;
      console.log({ departureDate, returnDate, departurePrefecture, returnPrefecture, travelers, styleName, userPref, attractions });

      // 4. 呼叫 GPT API
      try {
        const response = await fetch('/myapp/generate-itinerary/', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          credentials: 'include',
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) throw new Error('API 請求失敗');
        const data = await response.json();

        // 顯示行程產出區
        document.getElementById('itineraryContent').textContent = data.itinerary;
        document.getElementById('itinerarySection').style.display = 'block';
        //document.getElementById('bookingLinks').innerHTML = data.bookingLinksHtml || '';
        document.getElementById('itinerarySection').scrollIntoView({ behavior: 'smooth' });

        // 更新提示文字
        statusEl.innerText = '行程已生成！';
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);

      } catch (e) {
        alert('取得行程失敗，請稍後再試');
        console.error(e);
      }
    });


      
      // 行程調整送出
      document.getElementById('adjustBtn').addEventListener('click', () => {
      const adjustmentInput = document.getElementById('adjustmentInput').value.trim();
      if (!adjustmentInput) {
        alert('請輸入調整需求');
        return;
      }
      const itineraryContent = document.getElementById('itineraryContent').textContent.trim();
      const prompt = `這是先前的行程內容：\n${itineraryContent}\n\n請根據以下調整建議，重新規劃完整行程：\n${adjustmentInput}`;
      // 呼叫 API 更新行程
      fetch('/myapp/generate-itinerary/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // 其他需要的標頭 如 CSRF Token，若需要
        },
        body: JSON.stringify({ prompt: prompt }),
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('錯誤: ' + data.error);
          } else if (data.itinerary) {
            document.getElementById('itineraryContent').textContent = data.itinerary;
          } else {
            alert('發生未知錯誤');
          }
        })
        .catch(error => {
          console.error('請求失敗：', error);
          alert('行程更新失敗，請稍後再試');
        });
    });

     // 「一鍵打包並寄送」按鈕事件綁定
     document.addEventListener('DOMContentLoaded', () => {
        const packageBtn = document.getElementById('packageBtn');
        if (!packageBtn) {
          console.error('找不到 packageBtn 元素');
          return;
        }

        packageBtn.addEventListener('click', () => {
          // 讀取隱藏的 email 欄位值
          const emailElem = document.getElementById('id_email');
          const userEmail = emailElem ? emailElem.value.trim() : '';
          if (!userEmail) {
            alert('無法取得您的電子信箱，請先登入或重新載入頁面');
            return;
          }

          // 讀取行程內容區的文字
          const itineraryElem = document.getElementById('itineraryContent');
          const itineraryContent = itineraryElem ? itineraryElem.textContent.trim() : '';
          if (!itineraryContent) {
            alert('行程內容為空，無法寄送');
            return;
          }

          // 送出 POST 請求到後端 API
          fetch('/myapp/send-itinerary/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // 如果你有使用 CSRF token，這裡可加 'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
              email: userEmail,
              itinerary: itineraryContent,
            }),
          })
          .then(res => {
            console.log('Response status:', res.status);
            if (!res.ok) throw new Error('伺服器回應失敗');
            return res.json();
          })
          .then(data => {
            if (data.success) {
              alert('行程已寄送至您的信箱！');
            } else {
              alert('寄送失敗: ' + (data.error || '未知錯誤'));
            }
          })
          .catch(err => {
            console.error('寄送行程失敗:', err);
            alert('發生錯誤，請稍後再試');
          });
        });
      });


    </script>

 </body>

 <script>
  if (typeof jQuery === "undefined") {
    console.error("❗ jQuery 尚未載入！");
  } else {
    console.log("✅ jQuery 成功載入");
  }
  </script>

</html>
